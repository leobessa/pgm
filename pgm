#!/usr/bin/env ruby

print "Digite o nome do arquivo de entrada:"
file_name = gets.chomp + ".pgm"

puts """
Arquivo #{file_name} carregado com sucesso.
c - carga
t - exibicao na tela
n - negativo
r - rotacao
v - espelhamento vertical
h - espelhamento horizontal
x - corte
e - filtro da erosao
d - filtro da dilatacao
m - filtro da mediana
z - filtro da media
1 - filtro de bordas 1
2 - filtro de bordas 2
3 - filtro de bordas 3
g - gravacao
C - comparacao
a - ajuda
s - sair
"""
class MatrixFactory
  def initialize(content)
    @data = {}
    @line_count = 0
    @col_count = 0
    content.each_line.each_with_index do |line,i|
      @line_count = i if @line_count < i
      line.split(" ").each_with_index do |v,j|
        @col_count = j if @col_count < j
        @data[{i: i, j: j}] = Integer(v)
      end
    end
  end
  def build
    Matrix.new(@data, @line_count, @col_count)
  end
end

class Matrix
  attr_reader :line_count, :col_count
  def initialize(data, line_count, col_count)
    @data = data
    @line_count = line_count
    @col_count = col_count
  end
  
  def each_with_index
    0.upto(@line_count) do |i|
      0.upto(@col_count) do |j|
        yield @data[{i: i, j: j}], i, j
      end
    end
  end
  
  def to_s
    value = ""
    each_with_index do |v,i,j|
      value << @data[{i: i, j: j}].to_s
      if j == @col_count
        value << "\n"
      else
        value << " "
      end
    end
    value
  end

end

class Negative
  def initialize(m)
    @m = m
  end
  
  def build
    data = {}
    @m.each_with_index do |v,i,j|
      data[{i: i, j: j}] = 255 - v
    end
    Matrix.new(data, @m.line_count, @m.col_count)
  end
end

m = MatrixFactory.new(File.read(file_name)).build

begin
  print "Digite um comando:"
  command = gets
  case command
  when "t\n"
    puts
    puts m.to_s
  when "n\n"
    puts
    m = Negative.new(m).build
    puts m.to_s
  when "s\n"
    break
  end
end while command